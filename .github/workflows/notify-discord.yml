name: Discord Stock Notification

on:
  schedule:
    # í…ŒìŠ¤íŠ¸ ëª¨ë“œ: 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì•„ë˜ ì£¼ì„ í•´ì œí•˜ê³  ì´ ì¤„ ì‚­ì œ)
    - cron: '*/5 * * * *'
    # í•œêµ­ ì£¼ì‹ ì•Œë¦¼: ì˜¤ì „ 8ì‹œ KST (UTC 23:00 ì „ë‚ )
    # - cron: '0 23 * * 0-4'  # ì¼~ëª© UTC = ì›”~ê¸ˆ KST ì˜¤ì „ 8ì‹œ
    # ë¯¸êµ­ ì£¼ì‹ ì•Œë¦¼: ì˜¤í›„ 10:30 KST (UTC 13:30) - ë¯¸êµ­ì¥ ê°œì¥ 1ì‹œê°„ ì „
    # - cron: '30 13 * * 1-5'  # ì›”~ê¸ˆ UTC
  workflow_dispatch:
    inputs:
      region:
        description: 'ì•Œë¦¼ ì§€ì—­ (kr/us/both)'
        required: true
        default: 'both'
        type: choice
        options:
          - kr
          - us
          - both

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  notify-kr:
    runs-on: ubuntu-latest
    # í…ŒìŠ¤íŠ¸ ëª¨ë“œ: í•­ìƒ ì‹¤í–‰ / ìš´ì˜ ëª¨ë“œ: ì˜¤ì „ 8ì‹œ KST ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ì‹œ
    if: github.event.schedule == '*/5 * * * *' || github.event.schedule == '0 23 * * 0-4' || github.event.inputs.region == 'kr' || github.event.inputs.region == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read KR recommendations
        id: kr_data
        run: |
          if [ -f "data/kr/kr_recommendations.json" ]; then
            # JSONì—ì„œ í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
            UPDATED=$(jq -r '.updated_at' data/kr/kr_recommendations.json)
            STRONG_BUY=$(jq -r '.stats.strong_buy' data/kr/kr_recommendations.json)
            BUY=$(jq -r '.stats.buy' data/kr/kr_recommendations.json)
            KOSPI=$(jq -r '.market_summary.kospi_index' data/kr/kr_recommendations.json)
            KOSPI_CHG=$(jq -r '.market_summary.kospi_change_pct' data/kr/kr_recommendations.json)
            KOSDAQ=$(jq -r '.market_summary.kosdaq_index' data/kr/kr_recommendations.json)
            KOSDAQ_CHG=$(jq -r '.market_summary.kosdaq_change_pct' data/kr/kr_recommendations.json)

            # ìƒìœ„ 5ê°œ ì ê·¹ë§¤ìˆ˜ ì¢…ëª©
            TOP_STOCKS=$(jq -r '.recommendations.strong_buy[:5] | map("â€¢ \(.name) (\(.code)) - ì ìˆ˜: \(.score)") | join("\n")' data/kr/kr_recommendations.json)

            echo "updated=$UPDATED" >> $GITHUB_OUTPUT
            echo "strong_buy=$STRONG_BUY" >> $GITHUB_OUTPUT
            echo "buy=$BUY" >> $GITHUB_OUTPUT
            echo "kospi=$KOSPI" >> $GITHUB_OUTPUT
            echo "kospi_chg=$KOSPI_CHG" >> $GITHUB_OUTPUT
            echo "kosdaq=$KOSDAQ" >> $GITHUB_OUTPUT
            echo "kosdaq_chg=$KOSDAQ_CHG" >> $GITHUB_OUTPUT
            echo "top_stocks<<EOF" >> $GITHUB_OUTPUT
            echo "$TOP_STOCKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification (KR)
        if: steps.kr_data.outputs.has_data == 'true'
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "embeds": [{
                "title": "ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ì‹ ì˜¤ëŠ˜ì˜ ì¶”ì²œ",
                "color": 3447003,
                "fields": [
                  {
                    "name": "ğŸ“Š ì‹œì¥ í˜„í™©",
                    "value": "KOSPI: ${{ steps.kr_data.outputs.kospi }} (${{ steps.kr_data.outputs.kospi_chg }}%)\nKOSDAQ: ${{ steps.kr_data.outputs.kosdaq }} (${{ steps.kr_data.outputs.kosdaq_chg }}%)",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“ˆ ì¶”ì²œ ì¢…ëª© ìˆ˜",
                    "value": "ì ê·¹ë§¤ìˆ˜: ${{ steps.kr_data.outputs.strong_buy }}ê°œ\në§¤ìˆ˜: ${{ steps.kr_data.outputs.buy }}ê°œ",
                    "inline": false
                  },
                  {
                    "name": "ğŸš€ TOP ì ê·¹ë§¤ìˆ˜ ì¢…ëª©",
                    "value": "${{ steps.kr_data.outputs.top_stocks }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${{ steps.kr_data.outputs.updated }}"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            $DISCORD_WEBHOOK_URL

  notify-us:
    runs-on: ubuntu-latest
    # í…ŒìŠ¤íŠ¸ ëª¨ë“œ: í•­ìƒ ì‹¤í–‰ / ìš´ì˜ ëª¨ë“œ: ì˜¤í›„ 10:30 KST ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ì‹œ
    if: github.event.schedule == '*/5 * * * *' || github.event.schedule == '30 13 * * 1-5' || github.event.inputs.region == 'us' || github.event.inputs.region == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read US recommendations
        id: us_data
        run: |
          if [ -f "data/us/us_recommendations.json" ]; then
            UPDATED=$(jq -r '.updated_at' data/us/us_recommendations.json)
            STRONG_BUY=$(jq -r '.stats.strong_buy' data/us/us_recommendations.json)
            BUY=$(jq -r '.stats.buy' data/us/us_recommendations.json)
            SP500=$(jq -r '.market_summary.sp500_index // "N/A"' data/us/us_recommendations.json)
            SP500_CHG=$(jq -r '.market_summary.sp500_change_pct // "N/A"' data/us/us_recommendations.json)
            NASDAQ=$(jq -r '.market_summary.nasdaq_index // "N/A"' data/us/us_recommendations.json)
            NASDAQ_CHG=$(jq -r '.market_summary.nasdaq_change_pct // "N/A"' data/us/us_recommendations.json)

            TOP_STOCKS=$(jq -r '.recommendations.strong_buy[:5] | map("â€¢ \(.name) (\(.code)) - ì ìˆ˜: \(.score)") | join("\n")' data/us/us_recommendations.json)

            echo "updated=$UPDATED" >> $GITHUB_OUTPUT
            echo "strong_buy=$STRONG_BUY" >> $GITHUB_OUTPUT
            echo "buy=$BUY" >> $GITHUB_OUTPUT
            echo "sp500=$SP500" >> $GITHUB_OUTPUT
            echo "sp500_chg=$SP500_CHG" >> $GITHUB_OUTPUT
            echo "nasdaq=$NASDAQ" >> $GITHUB_OUTPUT
            echo "nasdaq_chg=$NASDAQ_CHG" >> $GITHUB_OUTPUT
            echo "top_stocks<<EOF" >> $GITHUB_OUTPUT
            echo "$TOP_STOCKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification (US)
        if: steps.us_data.outputs.has_data == 'true'
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "embeds": [{
                "title": "ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì£¼ì‹ ì˜¤ëŠ˜ì˜ ì¶”ì²œ",
                "color": 15844367,
                "fields": [
                  {
                    "name": "ğŸ“Š ì‹œì¥ í˜„í™© (ì „ì¼ ì¢…ê°€)",
                    "value": "S&P500: ${{ steps.us_data.outputs.sp500 }} (${{ steps.us_data.outputs.sp500_chg }}%)\nNASDAQ: ${{ steps.us_data.outputs.nasdaq }} (${{ steps.us_data.outputs.nasdaq_chg }}%)",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“ˆ ì¶”ì²œ ì¢…ëª© ìˆ˜",
                    "value": "ì ê·¹ë§¤ìˆ˜: ${{ steps.us_data.outputs.strong_buy }}ê°œ\në§¤ìˆ˜: ${{ steps.us_data.outputs.buy }}ê°œ",
                    "inline": false
                  },
                  {
                    "name": "ğŸš€ TOP ì ê·¹ë§¤ìˆ˜ ì¢…ëª©",
                    "value": "${{ steps.us_data.outputs.top_stocks }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${{ steps.us_data.outputs.updated }} | ë¯¸êµ­ì¥ ê°œì¥ 1ì‹œê°„ ì „"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            $DISCORD_WEBHOOK_URL
